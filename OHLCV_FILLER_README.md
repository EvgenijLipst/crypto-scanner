# OHLCV Filler - –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å—Ö–µ–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è OHLCV

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–∑—ã OHLCV –¥–ª—è –≤—Å–µ—Ö —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `coin_data` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞.

## üéØ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç OHLCV Filler

1. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–æ–∫–µ–Ω—ã** –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `coin_data`
2. **–°–æ–∑–¥–∞–µ—Ç –ø—É—Å—Ç—ã–µ —Å–≤–µ—á–∏** –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ –±–µ–∑ —Ç–æ—Ä–≥–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
3. **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω:
   - –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∏–∑–≤–µ—Å—Ç–Ω—É—é —Ü–µ–Ω—É –∏–∑ –±–∞–∑—ã
   - –ï—Å–ª–∏ –Ω–µ—Ç - –ø–æ–ª—É—á–∞–µ—Ç —Ü–µ–Ω—É —Å Coingecko API
4. **–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
npm install
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env` —Ñ–∞–π–ª:

```env
DATABASE_URL=postgresql://user:password@host:port/database
COINGECKO_API_KEY=your_api_key_here  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
OHLCV_FILL_INTERVAL_MINUTES=1        # –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –º–∏–Ω—É—Ç–∞—Ö
```

### 3. –ó–∞–ø—É—Å–∫

```bash
node start-ohlcv-filler.js
```

## üìä –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê–ª–≥–æ—Ä–∏—Ç–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è OHLCV

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤**: –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `coin_data`
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ—á–µ–π**: –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Å–≤–µ—á–∞ –∑–∞ —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥
3. **–°–æ–∑–¥–∞–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —Å–≤–µ—á–µ–π**: –ï—Å–ª–∏ —Å–≤–µ—á–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ—Ç "–ø—É—Å—Ç—É—é" —Å–≤–µ—á—É:
   - `open = high = low = close = price`
   - `volume = 0`
4. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—É—é —Å—Ö–µ–º—É:
   - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1**: –ü–æ—Å–ª–µ–¥–Ω—è—è –∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ü–µ–Ω–∞ –∏–∑ –±–∞–∑—ã OHLCV
   - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2**: –¶–µ–Ω–∞ —Å Coingecko API (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)

### –ü—Ä–∏–º–µ—Ä –ø—É—Å—Ç–æ–π —Å–≤–µ—á–∏

```sql
INSERT INTO ohlcv (mint, ts, o, h, l, c, v)
VALUES ('token_mint', 1640995200, 0.001234, 0.001234, 0.001234, 0.001234, 0);
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è                    | –û–ø–∏—Å–∞–Ω–∏–µ                                    | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é    |
| ----------------------------- | ------------------------------------------- | --------------- |
| `DATABASE_URL`                | –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL             | **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** |
| `COINGECKO_API_KEY`           | API –∫–ª—é—á Coingecko (–¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤) | `null`          |
| `OHLCV_FILL_INTERVAL_MINUTES` | –ò–Ω—Ç–µ—Ä–≤–∞–ª –∑–∞–ø—É—Å–∫–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö                  | `1`             |

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤

- **1 –º–∏–Ω—É—Ç–∞**: –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ —Å —á–∞—Å—Ç—ã–º–∏ —Å–¥–µ–ª–∫–∞–º–∏
- **5 –º–∏–Ω—É—Ç**: –î–ª—è –º–∞–ª–æ–ª–∏–∫–≤–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- **15 –º–∏–Ω—É—Ç**: –î–ª—è –æ—á–µ–Ω—å —Ä–µ–¥–∫–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤

## üìà –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π

### WebSocket Helius + OHLCV Filler

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   WebSocket     ‚îÇ    ‚îÇ   OHLCV Filler  ‚îÇ    ‚îÇ   Database      ‚îÇ
‚îÇ   Helius        ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ Real-time     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ ‚Ä¢ Fill gaps     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ ‚Ä¢ coin_data     ‚îÇ
‚îÇ   swap events   ‚îÇ    ‚îÇ ‚Ä¢ Get prices    ‚îÇ    ‚îÇ ‚Ä¢ ohlcv         ‚îÇ
‚îÇ ‚Ä¢ Active tokens ‚îÇ    ‚îÇ ‚Ä¢ Empty candles ‚îÇ    ‚îÇ ‚Ä¢ signals       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–∞–Ω–Ω—ã—Ö

1. **WebSocket Helius**: –†–µ–∞–ª—å–Ω—ã–µ swap —Å–æ–±—ã—Ç–∏—è ‚Üí —Ç–æ—á–Ω—ã–µ OHLCV
2. **OHLCV Filler**: –ü—É—Å—Ç—ã–µ —Å–≤–µ—á–∏ ‚Üí –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤
3. **Coingecko API**: –†–µ–∑–µ—Ä–≤–Ω—ã–µ —Ü–µ–Ω—ã ‚Üí –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏

## üõ†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```javascript
const { Database } = require("./src/database");
const { OHLCVFiller } = require("./src/fill-empty-ohlcv");

const database = new Database(process.env.DATABASE_URL);
await database.initialize();

const ohlcvFiller = new OHLCVFiller(database, process.env.COINGECKO_API_KEY);
```

### –ó–∞–ø—É—Å–∫

```javascript
// –ó–∞–ø—É—Å–∫ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 1 –º–∏–Ω—É—Ç–∞
ohlcvFiller.start(1);

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞
ohlcvFiller.stop();

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
const stats = ohlcvFiller.getStats();
console.log(stats.isRunning); // true/false
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º –±–æ—Ç–æ–º

```javascript
// –í –æ—Å–Ω–æ–≤–Ω–æ–º —Ñ–∞–π–ª–µ –±–æ—Ç–∞
const ohlcvFiller = new OHLCVFiller(database, coingeckoApiKey);

// –ó–∞–ø—É—Å–∫–∞–µ–º –≤–º–µ—Å—Ç–µ —Å WebSocket
heliusWebSocket.connect();
ohlcvFiller.start(1);

// Graceful shutdown
process.on("SIGINT", async () => {
  heliusWebSocket.disconnect();
  ohlcvFiller.stop();
  await database.close();
});
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### –õ–æ–≥–∏ OHLCV Filler

```
üöÄ Starting OHLCV filler with 1 minute interval
üîÑ Starting OHLCV fill cycle...
üìä Processing 1250 tokens from coin_data
üåê Fetching Coingecko prices for batch 1/5 (250 tokens)
üìà Using last known price for SOL: $98.45
üìä Created empty candle for SOL at 1640995200 with price 98.45
‚úÖ OHLCV fill cycle completed:
   ‚Ä¢ Processed: 1250 tokens
   ‚Ä¢ Empty candles created: 847
   ‚Ä¢ Prices fetched from Coingecko: 156
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

- **Processed**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- **Empty candles created**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç—ã—Ö —Å–≤–µ—á–µ–π
- **Prices fetched from Coingecko**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–µ–Ω, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Å Coingecko

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π –≤ OHLCV
SELECT COUNT(*) FROM ohlcv;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–µ—á–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
SELECT mint, COUNT(*) as candle_count
FROM ohlcv
WHERE ts >= EXTRACT(EPOCH FROM NOW() - INTERVAL '1 hour')
GROUP BY mint
ORDER BY candle_count DESC;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –±–µ–∑ —Å–≤–µ—á–µ–π
SELECT cd.mint, cd.symbol
FROM coin_data cd
LEFT JOIN ohlcv o ON cd.mint = o.mint
WHERE o.mint IS NULL;
```

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–ù–µ—Ç —Å–≤–µ—á–µ–π —Å–æ–∑–¥–∞–µ—Ç—Å—è**

   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `coin_data` –µ—Å—Ç—å —Ç–æ–∫–µ–Ω—ã
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏

2. **–ú–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Coingecko**

   - –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á Coingecko –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤
   - –£–≤–µ–ª–∏—á—å—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –∑–∞–ø—É—Å–∫–∞

3. **–í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤**
   - –£–º–µ–Ω—å—à–∏—Ç–µ —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—É—Å–∫–∞
   - –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ `coin_data`

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫

```bash
node start-ohlcv-filler.js
```

### PM2 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
pm2 start start-ohlcv-filler.js --name "ohlcv-filler"
pm2 save
pm2 startup
```

### Docker

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
CMD ["node", "start-ohlcv-filler.js"]
```

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License
